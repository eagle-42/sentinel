# üöÄ R√®gles Windsurf/Cascade pour Sentinel2

**Projet** : Sentinel2 - Syst√®me de Trading Algorithmique TDD  
**Version** : 2.0  
**Assistant** : Cascade (powered by Claude via Windsurf)  
**Statut** : ‚úÖ **PROJET FINALIS√â ET VALID√â**

---

## üìã **R√àGLES FONDAMENTALES**

### **1. Architecture TDD Stricte**
- **Tests AVANT impl√©mentation** : Toujours √©crire les tests en premier
- **100% de succ√®s requis** : Aucun code ne passe si les tests √©chouent
- **Couverture minimale** : 80% (actuellement 43%, en am√©lioration)
- **Types de tests** : Unit (99 tests), Integration (11 tests), E2E

### **2. Constantes et Configuration**
- **‚ùå JAMAIS de variables en brut** : Toujours utiliser `src/constants.py`
- **‚ùå JAMAIS de chemins en brut** : Utiliser `CONSTANTS.get_data_path()`
- **‚úÖ Configuration centralis√©e** : `src/constants.py` + `config/`
- **‚úÖ Variables d'environnement** : Toutes dans `.env` (jamais en dur)

### **3. Architecture Modulaire**
- **Fonctions < 100 lignes** : Refactoriser si d√©passement
- **Classes sp√©cialis√©es** : Une responsabilit√© par classe
- **S√©paration des responsabilit√©s** : Respect du principe SOLID
- **Imports organis√©s** : Standard ‚Üí Tiers ‚Üí Local (toujours en haut)

---

## üèóÔ∏è **STRUCTURE DU PROJET**

```
sentinel2/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ core/          # Modules fondamentaux (fusion, sentiment, prediction)
‚îÇ   ‚îú‚îÄ‚îÄ data/          # Gestion des donn√©es (storage, crawler)
‚îÇ   ‚îú‚îÄ‚îÄ gui/           # Interface Streamlit
‚îÇ   ‚îú‚îÄ‚îÄ models/        # Mod√®les ML (LSTM, Transformer)
‚îÇ   ‚îú‚îÄ‚îÄ tests/         # Tests TDD complets
‚îÇ   ‚îî‚îÄ‚îÄ constants.py   # TOUTES les constantes du projet
‚îú‚îÄ‚îÄ config/            # Configuration (config.json, models.json, settings.py)
‚îú‚îÄ‚îÄ data/              # Donn√©es (historical, realtime, models, logs, trading)
‚îú‚îÄ‚îÄ scripts/           # Scripts de maintenance (14 scripts)
‚îî‚îÄ‚îÄ .env               # Variables d'environnement (JAMAIS commit√©)
```

---

## üö® **INTERDICTIONS ABSOLUES**

### **‚ùå JAMAIS DE SIMULATIONS (CRITIQUE)**
- **‚ùå JAMAIS de prix simul√©s** : Uniquement donn√©es r√©elles du march√©
- **‚ùå JAMAIS de donn√©es artificielles** : Pas de fallback avec simulation
- **‚ùå JAMAIS de compensation** : Pas de strat√©gie de compensation artificielle
- **‚úÖ SEULE EXCEPTION** : Tests unitaires peuvent utiliser des mocks

### **‚ùå JAMAIS DE PATCHING ADDITIONNEL**
- **‚ùå JAMAIS de fichiers temporaires** : Corriger les imports existants
- **‚ùå JAMAIS de chemins cass√©s** : Utiliser les modules existants
- **‚úÖ TOUJOURS maintenir la coh√©rence** : Respect de l'architecture

### **‚ùå JAMAIS D'IMPORTS DANS LE CODE**
- **‚ùå JAMAIS dans les fonctions** : Tous les imports en haut du fichier
- **‚ùå JAMAIS d'imports conditionnels** : Pas d'imports dynamiques
- **‚úÖ TOUJOURS organis√©s** : Standard, tiers, local dans cet ordre

---

## üîß **R√àGLES DE D√âVELOPPEMENT**

### **Avant Modification**
1. **Lire le README.md** : Comprendre l'architecture actuelle
2. **V√©rifier les tests** : Tous doivent passer (100%)
3. **Consulter constants.py** : Utiliser les constantes existantes
4. **Backup si n√©cessaire** : Sauvegarder avant changements majeurs

### **Pendant Modification**
1. **Tests d'abord** : √âcrire le test avant le code
2. **Petits commits** : Modifications incr√©mentales
3. **Respect de l'architecture** : Suivre la structure existante
4. **Documentation inline** : Docstrings et type hints

### **Apr√®s Modification**
1. **Tests complets** : `uv run python scripts/test_system.py`
2. **Linting** : `ruff check` et `black` (si disponibles)
3. **Type checking** : `mypy` (si disponible)
4. **Documentation** : Mettre √† jour README si n√©cessaire

---

## üìä **STOCKAGE PARQUET**

### **R√®gle Critique : UN SEUL FICHIER PAR TYPE**
- **‚ùå PAS de doublons** : Ne jamais cr√©er plusieurs fichiers parquet
- **‚úÖ Sauvegarde incr√©mentale** : Ajouter au fichier existant
- **‚úÖ Coh√©rence** : `spy_1min.parquet`, `spy_news.parquet`, etc.
- **‚úÖ Performance** : √âviter la fragmentation des donn√©es

### **Structure des Donn√©es**
```
data/
‚îú‚îÄ‚îÄ historical/
‚îÇ   ‚îú‚îÄ‚îÄ yfinance/      # Donn√©es historiques Yahoo Finance
‚îÇ   ‚îî‚îÄ‚îÄ features/      # Features calcul√©es
‚îú‚îÄ‚îÄ realtime/
‚îÇ   ‚îú‚îÄ‚îÄ prices/        # Prix temps r√©el (refresh 15min)
‚îÇ   ‚îú‚îÄ‚îÄ news/          # News temps r√©el (refresh 4min)
‚îÇ   ‚îî‚îÄ‚îÄ sentiment/     # Sentiment analys√© (FinBERT)
‚îú‚îÄ‚îÄ models/            # Mod√®les ML entra√Æn√©s (LSTM, Transformer)
‚îú‚îÄ‚îÄ logs/              # Logs syst√®me
‚îî‚îÄ‚îÄ trading/
    ‚îî‚îÄ‚îÄ decisions_log/ # D√©cisions de trading (BUY/WAIT/SELL)
```

---

## üß™ **TESTS TDD**

### **Structure**
```
src/tests/
‚îú‚îÄ‚îÄ unit/          # Tests unitaires rapides
‚îú‚îÄ‚îÄ integration/   # Tests d'assemblage services
‚îî‚îÄ‚îÄ e2e/          # Tests end-to-end complets
```

### **Commandes**
```bash
# Tests complets syst√®me
uv run python scripts/test_system.py

# Tests unitaires
uv run pytest src/tests/unit/ -v

# Tests d'int√©gration
uv run pytest src/tests/integration/ -v

# Tests avec couverture
uv run pytest --cov=src --cov-report=html
```

### **R√®gles de Test**
- **Nommage** : `test_<fonction>_<scenario>`
- **Documentation** : Expliquer le test et les attentes
- **Isolation** : Chaque test ind√©pendant
- **Performance** : Suite compl√®te < 30 secondes

---

## üñ•Ô∏è **INTERFACE GUI (STREAMLIT)**

### **Structure**
```
src/gui/
‚îú‚îÄ‚îÄ main.py           # Point d'entr√©e Streamlit
‚îú‚îÄ‚îÄ pages/            # Pages de l'interface
‚îÇ   ‚îú‚îÄ‚îÄ production_page.py
‚îÇ   ‚îú‚îÄ‚îÄ analysis_page.py
‚îÇ   ‚îî‚îÄ‚îÄ logs_page.py
‚îú‚îÄ‚îÄ components/       # Composants r√©utilisables
‚îî‚îÄ‚îÄ services/         # Services m√©tier
    ‚îú‚îÄ‚îÄ data_service.py
    ‚îú‚îÄ‚îÄ chart_service.py
    ‚îú‚îÄ‚îÄ prediction_service.py
    ‚îî‚îÄ‚îÄ llm_service.py
```

### **R√®gles GUI**
- **S√©paration stricte** : UI dans pages, logique dans services
- **Cache intelligent** : `@st.cache_data` avec TTL
- **Chargement paresseux** : Donn√©es charg√©es si n√©cessaire
- **Responsive** : Adaptation mobile et desktop

### **D√©marrage**
```bash
# Mode production (avec Ollama LLM)
caffeinate -d ./scripts/sentinel2.sh prod

# Mode d√©veloppement (sans Ollama)
./scripts/sentinel2.sh dev

# Manuel
uv run streamlit run src/gui/main.py --server.port 8501
```

---

## üìã **FEATURES IMPL√âMENT√âES (8/9)**

### **Feature 1 : Configuration Centralis√©e** ‚öôÔ∏è
- Module : `config/` + `src/constants.py`
- Tests : `src/tests/test_config.py`
- Statut : ‚úÖ Valid√©

### **Feature 2 : Stockage Unifi√©** üíæ
- Module : `src/data/storage.py`, `src/data/unified_storage.py`
- Tests : `TestParquetStorage`, `TestDataStorage`
- Statut : ‚úÖ Valid√©

### **Feature 3 : Collecte de Donn√©es** üìä
- Module : `src/data/crawler.py`
- Scripts : `refresh_prices.py`, `refresh_news.py`
- Statut : ‚úÖ Valid√©

### **Feature 4 : Analyse de Sentiment** üí≠
- Module : `src/core/sentiment.py` (FinBERT)
- Scripts : `sentiment_service.py`
- Statut : ‚úÖ Valid√©

### **Feature 5 : Pr√©dictions LSTM** ü§ñ
- Module : `src/core/prediction.py`
- Notebooks : `src/notebooks/lstm_analysis.ipynb`
- Statut : ‚úÖ Valid√©

### **Feature 6 : Pr√©dictions Transformer** üß†
- Module : `src/core/transformer.py` (NVDA)
- Statut : ‚ö†Ô∏è EN D√âVELOPPEMENT

### **Feature 7 : Fusion Adaptative** üîÑ
- Module : `src/core/fusion.py`
- Logs : `data/trading/decisions_log/`
- Statut : ‚úÖ Valid√©

### **Feature 8 : Interface Utilisateur** üñ•Ô∏è
- Module : `src/gui/`
- URL : http://localhost:8501
- Statut : ‚úÖ Valid√©

### **Feature 9 : Scripts de Maintenance** üîß
- Module : `scripts/` (14 scripts)
- Script principal : `sentinel_main.py`
- Statut : ‚úÖ Valid√©

---

## ‚è∞ **PROCESSUS DE TRADING**

### **Intervalles de Collecte**
- **Prix** : Toutes les 15 minutes (Yahoo Finance + Polygon API)
- **News** : Toutes les 4 minutes (RSS + NewsAPI)
- **Fusion** : Toutes les 12 minutes (sentiment + pr√©dictions)

### **Processus de D√©cision**
1. **Collecte Prix** ‚Üí `data/realtime/prices/`
2. **Collecte News** ‚Üí `data/realtime/news/`
3. **Analyse Sentiment** ‚Üí `data/realtime/sentiment/`
4. **Pr√©dictions** ‚Üí `data/models/` (LSTM/Transformer)
5. **Fusion** ‚Üí D√©cision BUY/WAIT/SELL
6. **Sauvegarde** ‚Üí `data/trading/decisions_log/`
7. **Synth√®se Phi3** ‚Üí Explication de la d√©cision
8. **Frontend** ‚Üí Affichage temps r√©el avec confiance

### **Seuils de D√©cision**
- **BUY** : Signal > 0.3
- **SELL** : Signal < -0.3
- **HOLD** : Signal entre -0.3 et 0.3

---

## ‚ö†Ô∏è **V√âRIFICATION OBLIGATOIRE**

### **‚ùå JAMAIS dire "c'est fini" sans v√©rifier**
1. **‚úÖ Tester l'application** : Lancer et v√©rifier le fonctionnement
2. **‚úÖ V√©rifier les logs** : Pas d'erreurs dans le terminal
3. **‚úÖ Confirmer le d√©marrage** : Application accessible sans erreur
4. **‚úÖ Tester les fonctionnalit√©s** : V√©rifier les pages principales
5. **‚úÖ V√©rifier Streamlit** : http://localhost:8501 accessible

---

## üîÑ **CONFIRMATION OBLIGATOIRE POUR CHANGEMENTS MAJEURS**

### **Demander l'approbation de l'utilisateur AVANT :**
- **Modification de logique m√©tier** : Changer un algorithme existant
- **Refactoring majeur** : Restructuration importante
- **Suppression de code** : Retirer des fonctionnalit√©s
- **Changement d'architecture** : Modifier la structure
- **Ajout de d√©pendances** : Nouvelles biblioth√®ques

### **Process de confirmation**
1. **Expliquer le changement** : D√©crire clairement la modification
2. **D√©tailler l'impact** : Cons√©quences sur le syst√®me
3. **Proposer des alternatives** : Donner plusieurs options
4. **Attendre validation** : Ne pas proc√©der sans accord explicite

---

## üìà **M√âTRIQUES DE QUALIT√â**

### **Actuelles**
- **Tests** : 100% de succ√®s (99 unit + 11 system)
- **Couverture** : 43% (objectif 80%)
- **Features** : 89% (8/9) - 1 en d√©veloppement
- **Performance** : Tests < 7 secondes

### **Objectifs**
- **Couverture** : 80% minimum
- **Temps de chargement** : < 3 secondes pour l'interface
- **M√©moire** : < 500MB pour l'application
- **Cache hit rate** : > 80%

---

## üîß **SCRIPTS PRINCIPAUX**

### **Maintenance**
```bash
# Orchestrateur principal
uv run python scripts/sentinel_main.py --mode daemon

# Refresh des prix (15min)
uv run python scripts/refresh_prices.py

# Refresh des news (4min)
uv run python scripts/refresh_news.py

# Pipeline de trading complet
uv run python scripts/trading_pipeline.py

# Service de sentiment
uv run python scripts/sentiment_service.py

# Tests syst√®me complets
uv run python scripts/test_system.py
```

### **Script de Gestion**
```bash
# Mode production (avec Ollama)
./scripts/sentinel2.sh prod

# Mode d√©veloppement (sans Ollama)
./scripts/sentinel2.sh dev

# Arr√™ter l'application
./scripts/sentinel2.sh stop

# V√©rifier le statut
./scripts/sentinel2.sh status
```

---

## üö® **R√àGLES CRITIQUES (R√âSUM√â)**

1. **‚ùå JAMAIS de code sans tests** : TDD obligatoire
2. **‚ùå JAMAIS de variables en brut** : Utiliser `constants.py`
3. **‚ùå JAMAIS de simulations** : Donn√©es r√©elles uniquement
4. **‚ùå JAMAIS de doublons Parquet** : Un fichier par type
5. **‚ùå JAMAIS d'imports dans le code** : Tous en haut
6. **‚úÖ TOUJOURS demander confirmation** : Pour changements majeurs
7. **‚úÖ TOUJOURS v√©rifier avant de finir** : Tester l'application
8. **‚úÖ TOUJOURS respecter l'architecture** : Structure modulaire

---

## üéØ **WORKFLOW CASCADE OPTIMAL**

### **1. Analyse de la demande**
- Comprendre la requ√™te utilisateur
- Identifier les modules concern√©s
- V√©rifier les constantes existantes
- Consulter la documentation

### **2. Planification**
- Cr√©er un plan d'action clair
- Identifier les tests n√©cessaires
- √âvaluer l'impact sur l'architecture
- Demander confirmation si changement majeur

### **3. Impl√©mentation**
- √âcrire les tests d'abord (TDD)
- Impl√©menter le code minimal
- Respecter les r√®gles d'architecture
- Documenter inline (docstrings + type hints)

### **4. V√©rification**
- Ex√©cuter tous les tests (100% succ√®s requis)
- V√©rifier le fonctionnement r√©el
- Contr√¥ler les logs pour les erreurs
- Tester l'interface si concern√©e

### **5. Finalisation**
- Mettre √† jour la documentation
- Confirmer avec l'utilisateur
- Proposer des am√©liorations si pertinent

---

## üìö **RESSOURCES**

### **Documentation**
- **README.md** : Documentation principale compl√®te
- **README_ARCHITECTURE.md** : Architecture d√©taill√©e
- **READMEFUSION.md** : Documentation fusion adaptative
- **archive/** : Historique des README (10 versions num√©rot√©es)

### **Configuration**
- **env.example** : Template de configuration
- **.env** : Configuration locale (jamais commit√©)
- **config/** : Configuration JSON (config.json, models.json)
- **src/constants.py** : Constantes globales du projet

---

**Ces r√®gles sont adapt√©es sp√©cifiquement pour Windsurf/Cascade et doivent √™tre respect√©es √† chaque interaction avec le projet Sentinel2.**

**En cas de doute, toujours se r√©f√©rer √† ce document et au README.md principal.**

---

**Projet** : Sentinel2  
**Version** : 2.0  
**Statut** : ‚úÖ Finalis√© et Valid√©  
**Qualit√©** : üèÜ Excellente  
**Assistant** : Cascade (Windsurf)
